---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Settings - Showers Auto Detail">
  <div id="app" class="min-h-screen bg-gray-900 hidden">
    <header class="bg-gray-800 text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-xl font-bold">Showers Auto Detail</h1>
          <p class="text-gray-400 text-sm">Account Settings</p>
        </div>
        <div class="flex items-center gap-4">
          <a href="/manage" class="text-gray-300 hover:text-white text-sm">Dashboard</a>
          <button id="logout-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">Logout</button>
        </div>
      </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-8 space-y-6">
      <!-- 2FA Section -->
      <div class="bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-white mb-6">Two-Factor Authentication</h2>

        <div id="2fa-status" class="mb-6">
          <p class="text-gray-400">Loading 2FA status...</p>
        </div>

        <div id="2fa-disabled" class="hidden">
          <p class="text-gray-400 mb-4">2FA adds an extra layer of security to your account by requiring a code from your authenticator app when logging in.</p>
          <button id="setup-2fa-btn" class="bg-[#EB6C1D] hover:bg-[#D35E14] text-white font-semibold py-2 px-4 rounded-lg transition-colors">Enable 2FA</button>
        </div>

        <div id="2fa-setup" class="hidden">
          <p class="text-gray-400 mb-4">Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.):</p>
          <div class="flex justify-center mb-4 bg-white p-4 rounded-lg w-fit mx-auto">
            <img id="qr-code" class="rounded" />
          </div>
          <p class="text-sm text-gray-500 mb-2">Or enter this code manually:</p>
          <div class="bg-gray-700 p-3 rounded-lg mb-4 font-mono text-center text-lg text-white" id="manual-code"></div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-1">Enter verification code</label>
            <input type="text" id="verify-code" maxlength="6" pattern="[0-9]{6}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-center text-2xl tracking-widest" placeholder="000000" />
          </div>
          <button id="verify-2fa-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Verify and Enable</button>
        </div>

        <div id="2fa-enabled" class="hidden">
          <div class="flex items-center gap-3 mb-4 p-4 bg-green-900/30 rounded-lg border border-green-700">
            <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            <span class="text-green-400 font-medium">2FA is enabled</span>
          </div>
          <p class="text-gray-400 mb-4">To disable 2FA, enter your current authenticator code.</p>
          <div class="mb-4">
            <input type="text" id="disable-code" maxlength="6" pattern="[0-9]{6}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-center text-2xl tracking-widest" placeholder="000000" />
          </div>
          <button id="disable-2fa-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Disable 2FA</button>
        </div>

        <div id="2fa-error" class="mt-4 p-3 bg-red-900/50 text-red-300 rounded-lg hidden"></div>
        <div id="2fa-success" class="mt-4 p-3 bg-green-900/50 text-green-300 rounded-lg hidden"></div>
      </div>

      <!-- Account Info Section -->
      <div class="bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-white mb-4">Account Information</h2>
        <div id="account-info" class="space-y-2 text-gray-400">
          <p>Loading account info...</p>
        </div>
        <p class="mt-4 text-sm text-gray-500">Login credentials are managed via environment variables on the server.</p>
      </div>
    </main>
  </div>

  <script is:inline>
    var token = localStorage.getItem("accessToken");
    if (!token) {
      window.location.href = "/manage/login";
    } else {
      document.getElementById("app").classList.remove("hidden");
    }

    document.getElementById("logout-btn").onclick = function() {
      localStorage.clear();
      window.location.href = "/manage/login";
    };

    function showError(msg) {
      var el = document.getElementById("2fa-error");
      el.textContent = msg;
      el.classList.remove("hidden");
      setTimeout(function() { el.classList.add("hidden"); }, 5000);
    }

    function showSuccess(msg) {
      var el = document.getElementById("2fa-success");
      el.textContent = msg;
      el.classList.remove("hidden");
      setTimeout(function() { el.classList.add("hidden"); }, 5000);
    }

    // Load account info
    async function loadAccountInfo() {
      try {
        var res = await fetch("/api/auth/me", {
          headers: { "Authorization": "Bearer " + token }
        });
        if (res.status === 401) { window.location.href = "/manage/login"; return; }
        var data = await res.json();
        document.getElementById("account-info").innerHTML =
          '<div class="flex justify-between"><span class="text-gray-500">Email:</span><span class="text-white">' + data.user.email + '</span></div>' +
          '<div class="flex justify-between"><span class="text-gray-500">Name:</span><span class="text-white">' + (data.user.name || 'Admin') + '</span></div>' +
          '<div class="flex justify-between"><span class="text-gray-500">Role:</span><span class="text-white capitalize">' + data.user.role + '</span></div>' +
          '<div class="flex justify-between"><span class="text-gray-500">Member since:</span><span class="text-white">' + new Date(data.user.created_at).toLocaleDateString() + '</span></div>';
      } catch (e) {
        document.getElementById("account-info").innerHTML = '<p class="text-red-400">Failed to load account info</p>';
      }
    }

    // 2FA functions
    async function check2FAStatus() {
      try {
        var res = await fetch("/api/auth/2fa/status", {
          headers: { "Authorization": "Bearer " + token }
        });
        if (res.status === 401) { window.location.href = "/manage/login"; return; }
        var data = await res.json();
        document.getElementById("2fa-status").classList.add("hidden");
        if (data.enabled) {
          document.getElementById("2fa-enabled").classList.remove("hidden");
        } else {
          document.getElementById("2fa-disabled").classList.remove("hidden");
        }
      } catch (e) {
        showError("Failed to check 2FA status");
      }
    }

    document.getElementById("setup-2fa-btn").onclick = async function() {
      try {
        var res = await fetch("/api/auth/2fa/setup", {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error);
        document.getElementById("qr-code").src = data.qrCode;
        document.getElementById("manual-code").textContent = data.secret;
        document.getElementById("2fa-disabled").classList.add("hidden");
        document.getElementById("2fa-setup").classList.remove("hidden");
      } catch (e) {
        showError(e.message);
      }
    };

    document.getElementById("verify-2fa-btn").onclick = async function() {
      var code = document.getElementById("verify-code").value;
      if (!code || code.length !== 6) { showError("Enter 6-digit code"); return; }
      try {
        var res = await fetch("/api/auth/2fa/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify({ code: code })
        });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showSuccess("2FA enabled successfully!");
        document.getElementById("2fa-setup").classList.add("hidden");
        document.getElementById("2fa-enabled").classList.remove("hidden");
      } catch (e) {
        showError(e.message);
      }
    };

    document.getElementById("disable-2fa-btn").onclick = async function() {
      var code = document.getElementById("disable-code").value;
      if (!code || code.length !== 6) { showError("Enter 6-digit code"); return; }
      try {
        var res = await fetch("/api/auth/2fa/disable", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify({ code: code })
        });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showSuccess("2FA disabled");
        document.getElementById("2fa-enabled").classList.add("hidden");
        document.getElementById("2fa-disabled").classList.remove("hidden");
        document.getElementById("disable-code").value = "";
      } catch (e) {
        showError(e.message);
      }
    };

    // Initialize
    loadAccountInfo();
    check2FAStatus();
  </script>
</Layout>
